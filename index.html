<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tớ Có Điều Muốn Nói Thật Lòng!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Three.js for 3D Heart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Thiết lập nền gradient chuyển động mặc định */
            background: linear-gradient(-45deg, #ffe4e6, #f3e8ff, #e0f2fe, #ffeded);
            animation: gradient-animation 15s ease infinite;
            background-size: 400% 400%;
        }
        /* Nền đặc biệt cho màn hình thành công */
        .celebration-bg {
             background: linear-gradient(-45deg, #f06292, #f8bbd0, #e1bee7, #c5cae9);
             animation: gradient-animation 10s ease infinite;
             background-size: 400% 400%;
        }

        .screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
            text-align: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            position: absolute;
            inset: 0;
            opacity: 0;
            transform: scale(0.95);
        }
        .visible-screen {
            display: flex;
            opacity: 1;
            transform: scale(1);
            position: relative; 
        }
        /* Modal Overlay & Letter Modal */
        .modal-overlay, .letter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible, .letter-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .letter-content {
            background-color: #fffaf0; /* Màu giấy thư */
            border: 5px solid #fbcfe8; /* Border hồng nhạt */
            box-shadow: 0 10px 25px rgba(255, 0, 77, 0.3);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
            padding: 2rem;
            border-radius: 12px;
            position: relative;
            transform: rotate(-1deg); /* Hiệu ứng lá thư */
        }
        /* Gradient Animation */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Confetti Effect */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0;
            animation: confetti-fall 4s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        /* Falling Heart Effect */
        .falling-heart {
            position: fixed;
            top: -50px;
            font-size: 24px;
            color: #ff0044;
            pointer-events: none;
            z-index: 10;
            animation: heart-fall linear infinite;
        }
        @keyframes heart-fall {
            to { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }
        /* Running Button Fix (Quan trọng cho trải nghiệm di động) */
        #no-btn {
            transition: all 0.2s cubic-bezier(0.19, 1, 0.22, 1) !important; /* Dùng cubic-bezier để chuyển động mượt hơn */
            cursor: pointer;
        }
        .choice-buttons {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .choice-buttons.active {
            opacity: 1;
            pointer-events: all;
        }
        /* 3D Canvas Container */
        #heart-3d-container {
            width: 100%;
            max-width: 250px; /* Tối ưu cho mobile */
            height: 250px;
            margin: 1.5rem auto;
            overflow: hidden;
            border-radius: 50%; 
            box-shadow: 0 0 40px rgba(255, 0, 77, 0.5); /* Shadow mạnh mẽ hơn */
        }
        #heart-3d-container canvas {
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100">

    <script type="module">
        // --- Global Variables (Đơn giản hóa) ---
        let noButtonClicks = 0;
        let recipientName = "cậu"; // Tên thân mật, không cần nhập

        // Three.js Globals
        let scene, camera, renderer, heartMesh;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const heartContainer = document.getElementById('heart-3d-container');

        // UI elements and screens
        const screens = {
            confession: document.getElementById('confession-screen'),
            result: document.getElementById('result-screen'),
        };
        const modalOverlay = document.getElementById('modal-overlay');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const noBtn = document.getElementById('no-btn');
        const yesBtn = document.getElementById('yes-btn');
        const confessionHeading = document.getElementById('confession-heading');
        const choiceButtonsContainer = document.getElementById('choice-buttons-container');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const readLetterBtn = document.getElementById('read-letter-btn');
        const letterOverlay = document.getElementById('letter-overlay');
        const letterContentDiv = document.getElementById('letter-content-div');
        const closeLetterBtn = document.getElementById('close-letter-btn');
        const restartBtn = document.getElementById('restart-btn'); // Nút bắt đầu lại

        // Tone.js Synth for music and effects
        const synthYes = new Tone.Synth().toDestination();
        const synthNo = new Tone.Synth().toDestination();
        let backgroundLoop;
        let isAudioStarted = false;

        // --- Core Functions ---

        // Function to start background music (sau khi người dùng tương tác)
        const startBackgroundMusic = async () => {
            if (isAudioStarted) return;
            try {
                await Tone.start();
                isAudioStarted = true;
                
                // Simple romantic chord progression 
                const chords = [["C4", "E4", "G4", "B4"], ["A3", "C4", "E4", "G4"], ["F3", "A3", "C4", "E4"], ["G3", "B3", "D4", "F4"]];
                let chordIndex = 0;

                const synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.5, decay: 0.2, sustain: 0.5, release: 1 },
                    volume: -10 
                }).toDestination();

                backgroundLoop = new Tone.Loop((time) => {
                    const chord = chords[chordIndex % chords.length];
                    synth.triggerAttackRelease(chord, "2n", time);
                    chordIndex++;
                }, "2n").start(0);

                Tone.Transport.start();
            } catch (error) {
                 console.error("Lỗi khi khởi động Tone.js:", error);
            }
        };

        // Function to vibrate the device (Haptic Feedback)
        const vibrateDevice = (pattern) => {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        };

        // Function to reset the No button's state and position
        const resetNoButtonPosition = () => {
            noBtn.style.position = '';
            noBtn.style.left = '';
            noBtn.style.top = '';
            noBtn.style.zIndex = '';
            noBtn.classList.remove('absolute', 'fixed', 'top-0', 'left-0'); 
            noBtn.classList.add('transition-all', 'duration-300', 'transform', 'hover:scale-105');
        };

        // Function to transition between screens (Tối ưu hóa nền)
        const showScreen = (screenId) => {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('visible-screen');
            });
            
            if (screenId !== 'confession') {
                resetNoButtonPosition();
                if (backgroundLoop && isAudioStarted) {
                    Tone.Transport.stop();
                    isAudioStarted = false; 
                }
                
                // Áp dụng nền đặc biệt cho màn hình kết quả thành công
                if (screenId === 'result' && resultTitle.textContent.includes('Tuyệt vời')) {
                    document.body.classList.add('celebration-bg');
                } else {
                    document.body.classList.remove('celebration-bg');
                }
            } else {
                 document.body.classList.remove('celebration-bg');
            }

            if (screenId === 'confession') {
                startFallingHearts(); 
                choiceButtonsContainer.classList.remove('active');
                readLetterBtn.classList.remove('hidden');
                if (heartMesh) animateHeart();
            } else if (screenId === 'result') {
                resetNoButtonAndYesButton();
            }

            screens[screenId].classList.add('visible-screen');
        };

        // Function to show modal (Không dùng alert())
        const showModal = (message) => {
            modalMessage.textContent = message;
            modalOverlay.classList.add('visible');
        };
        
        // Function to create confetti effect (Remains the same)
        const createConfetti = () => {
            const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#3f51b5', '#2196f3', '#009688', '#ffeb3b', '#ff9800', '#ff5722'];
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        };

        // Function to create falling hearts effect (Remains the same)
        const createFallingHeart = () => {
            const heart = document.createElement('div');
            heart.innerHTML = '&#x2764;';
            heart.classList.add('falling-heart');
            heart.style.left = `${Math.random() * 100}vw`;
            heart.style.animationDuration = `${Math.random() * 8 + 5}s`;
            heart.style.opacity = `${Math.random() * 0.5 + 0.5}`;
            document.body.appendChild(heart);
             heart.addEventListener('animationend', () => heart.remove());
        };
        const startFallingHearts = () => {
            document.querySelectorAll('.falling-heart').forEach(h => h.remove());
            let lastTime = 0;
            const dropRate = 300; 

            const heartLoop = (currentTime) => {
                if (currentTime - lastTime > dropRate) {
                    createFallingHeart();
                    lastTime = currentTime;
                }
                if (screens.confession.classList.contains('visible-screen')) {
                    requestAnimationFrame(heartLoop);
                }
            };
            requestAnimationFrame(heartLoop);
        };

        // --- Three.js Logic for 3D Heart (Remains the same) ---
        const initThreeDHeart = () => {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, heartContainer.offsetWidth / heartContainer.offsetHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(heartContainer.offsetWidth, heartContainer.offsetHeight);
            heartContainer.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xff44aa, 1.8);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            const geometry = new THREE.IcosahedronGeometry(1.5, 1); 
            const material = new THREE.MeshPhongMaterial({ color: 0xff0044, shininess: 100, specular: 0xeeeeee });
            heartMesh = new THREE.Mesh(geometry, material);
            scene.add(heartMesh);

            camera.position.z = 3;

            const onResize = () => {
                const width = heartContainer.offsetWidth;
                const height = heartContainer.offsetHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            };
            window.addEventListener('resize', onResize);
            onResize(); 

            heartContainer.addEventListener('mousedown', onPointerDown);
            heartContainer.addEventListener('touchstart', onPointerDown);
            window.addEventListener('mouseup', onPointerUp);
            window.addEventListener('touchend', onPointerUp);
            window.addEventListener('mousemove', onPointerMove);
            window.addEventListener('touchmove', onPointerMove);
        };

        const onPointerDown = (event) => {
            event.preventDefault();
            isDragging = true;
            previousMousePosition.x = event.clientX || event.touches[0].clientX;
            previousMousePosition.y = event.clientY || event.touches[0].clientY;
        };

        const onPointerUp = () => {
            isDragging = false;
        };

        const onPointerMove = (event) => {
            if (!isDragging || !heartMesh) return;
            event.preventDefault();

            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);

            const deltaX = clientX - previousMousePosition.x;
            const deltaY = clientY - previousMousePosition.y;

            heartMesh.rotation.y += deltaX * 0.01;
            heartMesh.rotation.x += deltaY * 0.01;

            previousMousePosition.x = clientX;
            previousMousePosition.y = clientY;
        };

        const animateHeart = () => {
            requestAnimationFrame(animateHeart);
            if (!heartMesh) return;

            const time = performance.now() * 0.001;
            
            if (!isDragging) {
                heartMesh.rotation.y += 0.005;
            }

            const scaleFactor = 1.0 + Math.sin(time * 5) * 0.05; 
            heartMesh.scale.set(scaleFactor, scaleFactor, scaleFactor);

            renderer.render(scene, camera);
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initThreeDHeart(); // Khởi tạo trái tim 3D
            
            // Set initial screen and heading (since no welcome screen)
            confessionHeading.textContent = `${recipientName} ơi, tớ có điều muốn nói thật lòng!`;
            showScreen('confession'); 
        });

        // --- Letter Logic ---
        readLetterBtn.addEventListener('click', () => {
            // Khởi động nhạc ngay khi có tương tác đầu tiên
            startBackgroundMusic();

            letterContentDiv.innerHTML = `
                <h3 class="text-3xl font-serif font-bold text-gray-800 border-b-2 border-pink-300 pb-3 mb-6">Bức Thư Tỏ Tình Chân Thành</h3>
                <p class="text-xl font-semibold mb-4 text-pink-600">Gửi ${recipientName} (người tớ thương),</p>
                <p class="mb-4 text-gray-700 leading-relaxed italic">
                    Tình cảm này không phải là thoáng qua, nó đã được vun đắp từ những điều nhỏ nhặt nhất. Cậu là người mang đến sự bình yên và niềm vui cho tớ.
                    Mỗi giây phút bên cậu đều là một món quà. Trái tim tớ giờ đây đã dành trọn cho cậu, và tớ mong rằng cậu cũng cảm nhận được sự chân thành này.
                </p>
                <p class="mb-6 text-gray-700 leading-relaxed italic">
                    Nếu cậu đồng ý, tớ sẽ là người đồng hành tuyệt vời nhất của cậu, cùng cậu chia sẻ mọi điều trong cuộc sống. Tớ yêu cậu, thật sự rất nhiều!
                </p>
                <p class="text-lg font-bold text-gray-800 pt-4">
                    Liệu tớ có thể trở thành "người ấy" của cậu không?
                </p>
            `;
            letterOverlay.classList.add('visible');
        });

        closeLetterBtn.addEventListener('click', () => {
            letterOverlay.classList.remove('visible');
            readLetterBtn.classList.add('hidden');
            choiceButtonsContainer.classList.add('active');
        });


        // --- Nút "Không đồng ý" chạy trốn ---
        const moveNoButton = () => {
            if (!choiceButtonsContainer.classList.contains('active')) return;
            vibrateDevice([50]); 

            if (noBtn.style.position !== 'fixed') {
                const rect = noBtn.getBoundingClientRect();
                noBtn.style.position = 'fixed';
                noBtn.style.left = `${rect.left}px`;
                noBtn.style.top = `${rect.top}px`;
                noBtn.style.zIndex = '50'; 
                yesBtn.classList.add('w-full');
            }
            
            const buttonWidth = noBtn.offsetWidth;
            const buttonHeight = noBtn.offsetHeight;
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            const maxX = viewportWidth - buttonWidth - 10;
            const maxY = viewportHeight - buttonHeight - 10;
            
            const randomX = Math.max(10, Math.random() * maxX); 
            const randomY = Math.max(10, Math.random() * maxY); 
            
            noBtn.style.left = `${randomX}px`;
            noBtn.style.top = `${randomY}px`;
        };

        const resetNoButtonAndYesButton = () => {
            resetNoButtonPosition();
            yesBtn.classList.remove('w-full');
        };

        noBtn.addEventListener('mouseenter', moveNoButton);
        noBtn.addEventListener('touchstart', moveNoButton);

        // --- Logic Nút Đồng Ý (Yes) ---
        yesBtn.addEventListener('click', () => {
            vibrateDevice([300]); 
            resetNoButtonAndYesButton();
            // Tin nhắn ý nghĩa và đẹp hơn
            resultTitle.textContent = 'Tuyệt vời! Tớ hạnh phúc quá!';
            resultMessage.textContent = 'Tình yêu của chúng ta bắt đầu từ đây. Cảm ơn cậu đã tin tưởng tớ! Mãi yêu! ❤️';
            showScreen('result');
            createConfetti();
            synthYes.triggerAttackRelease("C5", "8n");
            synthYes.triggerAttackRelease("E5", "8n", "+0.2");
            synthYes.triggerAttackRelease("G5", "8n", "+0.4");
        });

        // --- Logic Nút Không Đồng Ý (No) ---
        noBtn.addEventListener('click', () => {
            vibrateDevice([500]); 
            resetNoButtonAndYesButton(); 
            
            noButtonClicks++;
            if (noButtonClicks === 1) {
                noBtn.textContent = 'Tớ vẫn chờ cậu.';
                showModal('Cậu có chắc không? Tình cảm của tớ là thật lòng...');
                choiceButtonsContainer.classList.add('active'); 
            } else if (noButtonClicks === 2) {
                noBtn.textContent = 'Cho tớ thêm cơ hội?';
                showModal('Tớ biết tớ chưa hoàn hảo, nhưng hãy cho tớ một cơ hội để chứng minh nhé?');
                choiceButtonsContainer.classList.add('active'); 
            } else {
                // Tin nhắn nhẹ nhàng, tôn trọng và hy vọng
                resultTitle.textContent = 'Tớ tôn trọng quyết định của cậu.';
                resultMessage.textContent = 'Dù sao đi nữa, tớ vẫn sẽ ở đây. Tớ sẽ cố gắng để một ngày nào đó cậu thay đổi ý định. Cảm ơn cậu vì đã đọc thư tớ.';
                showScreen('result');
                synthNo.triggerAttackRelease("C3", "4n");
                synthNo.triggerAttackRelease("B2", "4n", "+0.5");
                synthNo.triggerAttackRelease("A2", "4n", "+1.0");
            }
        });

        // Nút Bắt đầu lại (thay cho Đổi tên)
        restartBtn.addEventListener('click', () => {
            window.location.reload(); 
        });

        modalCloseBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('visible');
        });
    </script>

    <!-- Screen 1: The Confession (Màn hình chính, bắt đầu tại đây) -->
    <div id="confession-screen" class="screen visible-screen">
        <div class="p-6 bg-white rounded-3xl shadow-2xl border-4 border-pink-300 w-full max-w-sm flex flex-col items-center">
            <h2 id="confession-heading" class="text-2xl font-bold text-pink-600 mb-4"></h2>
            
            <!-- 3D Heart Container -->
            <div id="heart-3d-container" class="rounded-full shadow-inner">
                <!-- Three.js Canvas will be placed here -->
            </div>
            
            <!-- Letter Button -->
            <button id="read-letter-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 mb-6 active:scale-95">
                💌 Mở Bức Thư Tỏ Tình
            </button>

            <!-- Choice Buttons Container - Initially Hidden -->
            <div id="choice-buttons-container" class="w-full flex flex-col sm:flex-row justify-center gap-4 choice-buttons">
                <button id="yes-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-full shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                    Đồng ý
                </button>
                <button id="no-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-full shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                    Không đồng ý
                </button>
            </div>
            <!-- Nút Bắt đầu lại (Reload trang để reset trạng thái) -->
            <button id="restart-btn" class="mt-8 text-sm text-purple-500 hover:text-purple-600 transition-colors font-semibold">Bắt đầu lại</button>
        </div>
    </div>

    <!-- Screen 2: The Result (Đẹp hơn và ý nghĩa hơn) -->
    <div id="result-screen" class="screen">
        <div class="p-8 bg-white rounded-3xl shadow-2xl border-4 border-pink-300 w-full max-w-sm">
            <h2 id="result-title" class="text-4xl font-extrabold text-pink-600 mb-4"></h2>
            <p id="result-message" class="text-xl text-gray-700 font-medium"></p>
        </div>
    </div>

    <!-- Modal for notifications -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="p-8 bg-white rounded-3xl shadow-2xl border-4 border-pink-300 w-full max-w-xs text-center">
            <p id="modal-message" class="text-lg text-gray-700 font-semibold mb-6"></p>
            <button id="modal-close-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-all duration-300 active:scale-95">
                Đóng
            </button>
        </div>
    </div>

    <!-- Letter Modal -->
    <div id="letter-overlay" class="letter-overlay">
        <div class="letter-content w-full max-w-xl">
            <div id="letter-content-div" class="text-base sm:text-lg">
                <!-- Letter content will be inserted by JS -->
            </div>
            <div class="text-center mt-8">
                <button id="close-letter-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95">
                    Đã đọc, tớ đã hiểu!
                </button>
            </div>
        </div>
    </div>
</body>
</html>
